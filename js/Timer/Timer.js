import{sessionStartName,distractionMessage,workMode,shortBreakMode,longBreakMode,buttonText}from"./TimerVariables.js";import{workModeColors}from"../Misc/ChangeColors.js";import{timeToString}from"../Misc/UtilityFunctions.js";class Timer extends HTMLElement{constructor(t,e,s){super(),this.state="",this.stateQueue=[],this.startButton=t,this.timeDisplay=e,this.displayStatus=s,this.focusTime=document.getElementById("focusTime"),this.shortBreakTime=document.getElementById("shortBreakTime"),this.longBreakTime=document.getElementById("longBreakTime"),this.autoStart=document.getElementById("autoStartSwitch"),this.timerWorker=new Worker("./js/Timer/TimerWorker.js"),this.timerWorker.onmessage=t=>{-1!==t.data?(this.timeDisplay.textContent=t.data,document.title=`${t.data} ${this.state}`):this.onTimerComplete()},this.sessionId=localStorage.getItem("pomoSessionId"),this.sessionId=null===this.sessionId?0:parseInt(this.sessionId,10)+1;const o=[workMode,shortBreakMode,workMode,shortBreakMode,workMode,shortBreakMode,workMode,longBreakMode];this.stateQueue=o,null!==localStorage.getItem("workModeTime")&&(workMode.duration=localStorage.getItem("workModeTime")),null!==localStorage.getItem("shortBreakTime")&&(shortBreakMode.duration=localStorage.getItem("shortBreakTime")),null!==localStorage.getItem("longBreakTime")&&(longBreakMode.duration=localStorage.getItem("longBreakTime")),null!==this.focusTime&&(this.focusTime.value=workMode.duration,this.shortBreakTime.value=shortBreakMode.duration,this.longBreakTime.value=longBreakMode.duration),null!==this.timeDisplay&&(this.timeDisplay.textContent=timeToString(60*workMode.duration)),this.addEventListeners()}resetPomoSessionId(){this.sessionId=0,localStorage.setItem("pomoSessionId",this.sessionId)}onTimerComplete(){const t=this.stateQueue.shift(),e=this.stateQueue[0].name,s="./assets/img/webicon.png";"Notification"in window&&"granted"===Notification.permission&&("Short Break"===e?new Notification("Pomo XV",{body:"Time for a short break!",icon:s}):"Working Time"===e?new Notification("Pomo XV",{body:"Time to work!",icon:s}):"Long Break"===e&&new Notification("Pomo XV",{body:"Time for a long break!",icon:s})),this.stateQueue.push(t);const o=new CustomEvent("timer-complete",{detail:{sessionName:t.name,duration:t.duration,sessionIsWork:t.isWork,sessionId:this.sessionId,nextSessionName:this.stateQueue[0].name,longBreakLocation:this.stateQueue.findIndex((t=>t===longBreakMode))}});this.dispatchEvent(o),t.isWork||(this.sessionId+=1,localStorage.setItem("pomoSessionId",this.sessionId)),!1===this.autoStart.checked?(this.state=this.stateQueue[0].name,this.updateDisplay()):this.startTimer()}startTimer(){const t=this.stateQueue[0];this.state=t.name,this.displayStatus.textContent=this.state;const e=new CustomEvent("timer-start",{detail:{sessionName:this.state,sessionIsWork:t.isWork}});this.dispatchEvent(e),this.timerWorker.postMessage(60*t.duration)}endTimer(){this.timerWorker.postMessage(-1),this.displayStatus.textContent=sessionStartName,this.timeDisplay.textContent=timeToString(60*workMode.duration),document.title="PomoXV",this.stateQueue=[];const t=[workMode,shortBreakMode,workMode,shortBreakMode,workMode,shortBreakMode,workMode,longBreakMode];for(let e=0;e<t.length;e+=1)this.stateQueue.push(t[e]);const e=new CustomEvent("timer-end");this.dispatchEvent(e);const s=document.querySelectorAll(".indicator");for(let t=0;t<s.length;t+=1)s[t].textContent="trip_origin";this.timeDisplay.className="show-focus-time"}resetSession(){this.timerWorker.postMessage(-1),this.updateDisplay(),this.displayStatus.textContent=distractionMessage,document.title="Distracted"}changeTime(t){0===t.target.value&&(t.target.value=1),t.target.value>99&&(t.target.value=99),"focusTime"===t.target.id?("show-focus-time"===this.timeDisplay.className&&(this.timeDisplay.textContent=`${t.target.value}:00`),workMode.duration=t.target.value,localStorage.setItem("workModeTime",t.target.value)):"shortBreakTime"===t.target.id?("show-short-break-time"===this.timeDisplay.className&&(this.timeDisplay.textContent=`${t.target.value}:00`),shortBreakMode.duration=t.target.value,localStorage.setItem("shortBreakTime",t.target.value)):"longBreakTime"===t.target.id&&("show-long-break-time"===this.timeDisplay.className&&(this.timeDisplay.textContent=`${t.target.value}:00`),longBreakMode.duration=t.target.value,localStorage.setItem("longBreakTime",t.target.value))}addEventListeners(){this.startButton.addEventListener("click",(()=>{this.startButton.textContent.indexOf(buttonText.startTimerText)>-1?(this.startTimer(),this.startButton.childNodes[0].nodeValue=buttonText.stopTimerText):(this.endTimer(),this.startButton.childNodes[0].nodeValue=buttonText.startTimerText,workModeColors())})),this.focusTime.addEventListener("change",(t=>{this.changeTime(t)})),this.shortBreakTime.addEventListener("change",(t=>{this.changeTime(t)})),this.longBreakTime.addEventListener("change",(t=>{this.changeTime(t)}))}updateDisplay(){this.startButton.childNodes[0].nodeValue=buttonText.startTimerText;const t=this.stateQueue[0];this.displayStatus.textContent=this.state,this.timeDisplay.textContent=timeToString(60*t.duration),"Working Time"===t.name?this.timeDisplay.className="show-focus-time":"Short Break"===t.name?this.timeDisplay.className="show-short-break-time":"Long Break"===t.name&&(this.timeDisplay.className="show-long-break-time"),document.title=t.name;const e=new CustomEvent("timer-end");this.dispatchEvent(e)}}customElements.define("custom-timer",Timer);export{Timer};
